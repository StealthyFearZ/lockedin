{% extends 'base.html' %}
{% block content %}
{% load static %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
     <!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>

<style>
    #map {
        height: 500px;
        width: 100%;
    }
    .dropdown {
        display: flex;
        justify-content: flex-end;
    }
</style>

<div class="col-auto">
    <div class="dropdown">
        <button class="btn btn-dark-outline dropdown-toggle" data-bs-toggle="dropdown" type="button">Filter</button>
        <div class="dropdown-menu p-3" style="min-width: 350px;">
            <!--Distance Filter-->
            <div class="mb-2" id="filterDropdown">
                <label class="form-label mb-1">Maximum Distance (mi)</label>
                <div class="row">
                <div class="col">
                    <input type="number" class="form-control" id="max_distance" name="max_distance" 
                    placeholder="Maximum Distance" value="{{request.GET.max_distance}}">
                </div>
                </div>
            </div>
            <div class="col-auto">
                <button class="btn bg-dark text-white" id="submit" type="submit">Search</button>
            </div>
        </div>   
    </div>
</div>
<div id="map"></div>

<script>
    var map = L.map('map').setView([33.776174, -84.398815], 14); // Location of Georgia Tech campus

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    /*
    // Test marker
    var marker = L.marker([33.774841, -84.396407]).addTo(map); // Location of CS2340 classroom
    marker.bindPopup("<b>CS2340 Developer</b><br>260 4th Street NW<br>Atlanta, GA 30332")
    */

    // Generate javascript object using JSON job list
    const jobs = JSON.parse('{{ jobs_json|escapejs }}');

    // Default distance filter
    let miles = 1000000;

    // Capture input value from distance filtering form
    const filterDropdown = document.getElementById('filterDropdown');
    const submitBtn = document.getElementById('submit');
    submitBtn.addEventListener('click', function(event) {
        event.preventDefault();                                         // Prevent page from refreshing
        const distanceInput = document.getElementById('max_distance');  // Get form input element
        miles = Number(distanceInput.value);                            // Store input value
        renderMarkers();                                                // Redraw map markers
    });

    // Intial render
    renderMarkers();

    // Displays markers within specified filter distance
    function renderMarkers() {
        console.log('renderMarkers called, miles =', miles);
        // Remove all existing markers
        map.eachLayer(layer => {
            if (layer instanceof L.Marker) {
                map.removeLayer(layer);
            }
        });

        // Redraw markers
        jobs.forEach(j => {
                x = j.fields.location_x
                y = j.fields.location_y
                // Filter by leaflet's Latlng distanceTo function and only add markers within specified distance
                // Currently uses Georgia Tech as reference location
                if(L.latLng([x, y]).distanceTo([33.776174, -84.398815]) < (miles * 1609.34)) {
                    marker = L.marker([x, y]).addTo(map)
                    marker.bindPopup(`<b>${j.fields.title}</b><br>${j.fields.location}`)
                }
            });
    }
</script>

{% endblock content %}